# NPS 邮件备份功能文档

## 概述

NPS 邮件备份功能是一个自动化的数据备份解决方案，可以定期将 NPS 服务器的配置数据和客户端信息打包成 ZIP 文件，并通过邮件发送到指定邮箱，确保数据安全和可恢复性。

## 功能特性

- **自动定时备份**: 支持按小时间隔自动执行备份任务
- **邮件发送**: 将备份文件作为附件通过 SMTP 邮件发送
- **数据完整性**: 备份包含客户端配置、任务配置、主机配置和服务器配置
- **文件清理**: 自动清理过期的备份文件，节省存储空间
- **多邮箱支持**: 支持同时发送到多个邮箱地址
- **安全传输**: 支持 TLS/SSL 加密邮件传输

## 备份内容

备份文件包含以下重要数据：

1. **clients.json** - 客户端配置信息
   - 客户端验证密钥
   - 客户端备注信息
   - 客户端状态和权限设置

2. **tasks.json** - 任务配置信息
   - 端口映射配置
   - 代理任务设置
   - 流量控制规则

3. **hosts.json** - 主机配置信息
   - 域名映射配置
   - SSL 证书设置
   - 访问控制规则

4. **nps.conf** - 服务器主配置文件
   - 服务器运行参数
   - 网络配置
   - 安全设置

## 配置说明

### 基础配置

在 `nps.conf` 配置文件中添加以下配置项：

```ini
# 启用邮件备份功能
email_backup_enabled=true

# 备份间隔（小时）
email_backup_interval=24

# SMTP 服务器配置
email_smtp_host=smtp.163.com
email_smtp_port=587
email_smtp_username=your_email@163.com
email_smtp_password=your_auth_code
email_smtp_tls=true

# 邮件发送配置
email_from=your_email@163.com
email_to=backup@example.com,admin@example.com
email_subject=NPS数据库备份报告

# 备份文件保留天数
email_backup_retention=7
```

### 配置参数详解

| 参数名 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| `email_backup_enabled` | bool | false | 是否启用邮件备份功能 |
| `email_backup_interval` | int | 24 | 备份间隔时间（小时） |
| `email_smtp_host` | string | - | SMTP 服务器地址 |
| `email_smtp_port` | int | 587 | SMTP 服务器端口 |
| `email_smtp_username` | string | - | SMTP 用户名 |
| `email_smtp_password` | string | - | SMTP 密码或授权码 |
| `email_smtp_tls` | bool | true | 是否启用 TLS 加密 |
| `email_from` | string | - | 发件人邮箱地址 |
| `email_to` | string | - | 收件人邮箱地址（多个用逗号分隔） |
| `email_subject` | string | - | 邮件主题 |
| `email_backup_retention` | int | 30 | 备份文件保留天数 |

## 常用邮箱配置示例

### 163 邮箱
```ini
email_smtp_host=smtp.163.com
email_smtp_port=587
email_smtp_tls=true
```

### QQ 邮箱
```ini
email_smtp_host=smtp.qq.com
email_smtp_port=587
email_smtp_tls=true
```

### Gmail
```ini
email_smtp_host=smtp.gmail.com
email_smtp_port=587
email_smtp_tls=true
```

### 企业邮箱
```ini
email_smtp_host=smtp.exmail.qq.com
email_smtp_port=587
email_smtp_tls=true
```

## 使用步骤

### 1. 配置邮箱服务

首先需要在邮箱服务商处开启 SMTP 服务并获取授权码：

**163 邮箱设置步骤：**
1. 登录 163 邮箱
2. 进入"设置" → "POP3/SMTP/IMAP"
3. 开启"SMTP服务"
4. 获取授权码（不是登录密码）

**QQ 邮箱设置步骤：**
1. 登录 QQ 邮箱
2. 进入"设置" → "账户"
3. 开启"POP3/SMTP服务"
4. 获取授权码

### 2. 修改配置文件

编辑 `nps.conf` 文件，添加邮件备份相关配置：

```ini
# 启用邮件备份
email_backup_enabled=true
email_backup_interval=24

# 配置 SMTP 信息
email_smtp_host=smtp.163.com
email_smtp_port=587
email_smtp_username=your_email@163.com
email_smtp_password=your_auth_code
email_smtp_tls=true

# 配置邮件信息
email_from=your_email@163.com
email_to=backup@example.com
email_subject=NPS数据库备份报告
email_backup_retention=7
```

### 3. 重启 NPS 服务

修改配置后需要重启 NPS 服务使配置生效：

```bash
# Linux/macOS
sudo systemctl restart nps

# Windows
# 重启 NPS 服务或重新运行程序
```

### 4. 验证功能

启动后，系统会按照设定的间隔自动执行备份任务。你也可以通过日志查看备份执行情况：

```bash
# 查看日志
tail -f nps.log | grep -i backup
```

## 备份文件格式

备份文件命名格式：`nps_backup_YYYYMMDD_HHMMSS.zip`

例如：`nps_backup_20240315_143022.zip`

备份文件存储位置：
- Linux/macOS: `/etc/npx/backups/`
- Windows: `C:\Program Files\npx\backups\`

## 故障排除

### 常见问题

**1. 邮件发送失败**
- 检查 SMTP 配置是否正确
- 确认邮箱授权码是否有效
- 检查网络连接和防火墙设置
- 查看日志中的详细错误信息

**2. 备份文件为空**
- 确认数据库文件路径正确
- 检查文件读取权限
- 验证数据是否已正确存储到数据库

**3. 邮件收不到**
- 检查收件人邮箱地址是否正确
- 查看垃圾邮件文件夹
- 确认邮件服务商的发送限制

### 调试方法

**启用详细日志：**
```ini
log_level=7
```

**手动测试备份功能：**
可以通过 Web 管理界面的状态页面手动触发备份操作进行测试。

## 安全建议

1. **保护配置文件**: 确保 `nps.conf` 文件权限设置正确，避免密码泄露
2. **使用授权码**: 不要使用邮箱登录密码，使用专门的 SMTP 授权码
3. **加密传输**: 始终启用 TLS 加密（`email_smtp_tls=true`）
4. **定期更换密码**: 定期更换邮箱授权码
5. **限制收件人**: 只发送到可信任的邮箱地址

## 性能优化

1. **合理设置备份间隔**: 根据数据变化频率设置合适的备份间隔
2. **及时清理旧备份**: 设置合理的保留天数，避免占用过多存储空间
3. **监控邮箱容量**: 确保收件邮箱有足够空间接收备份文件

## 版本历史

- **v1.0** (2024-03-15): 初始版本，支持基础邮件备份功能
- **v1.1** (2024-09-29): 修复路径不一致问题，确保备份数据完整性

## 技术支持

如果在使用过程中遇到问题，可以：

1. 查看项目 [GitHub Issues](https://github.com/ehang-io/nps/issues)
2. 参考 [官方文档](https://ehang-io.github.io/nps)
3. 加入社区讨论群组

---

**注意**: 请妥善保管邮箱授权码等敏感信息，不要将其提交到版本控制系统中。